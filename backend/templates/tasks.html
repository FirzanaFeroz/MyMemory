{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-md-12">
            <h2>Add a Task</h2>
            <form id="task-form">
                <div class="form-group mb-3">
                    <label for="task-name" class="form-label">Task Name</label>
                    <input type="text" class="form-control" id="task-name" name="name" required>
                </div>
                
                <div class="form-group mb-3">
                    <label for="task-description" class="form-label">Description (Optional)</label>
                    <textarea class="form-control" id="task-description" name="description" rows="3"></textarea>
                </div>
                
                <div class="row">
                    <div class="col-md-6 form-group mb-3">
                        <label for="reminder-time" class="form-label">Reminder Time (Optional)</label>
                        <input type="datetime-local" class="form-control" id="reminder-time" name="reminder_time">
                    </div>
                    
                    <div class="col-md-6 form-group mb-3">
                        <label for="repeat-type" class="form-label">Repeat Type</label>
                        <select class="form-select" id="repeat-type" name="repeat_type">
                            <option value="">No Repeat</option>
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                            <option value="custom">Custom Days</option>
                        </select>
                    </div>
                </div>
                
                <div id="repeat-details-container" style="display:none;">
                    <div class="row mb-3" id="weekly-repeat-container" style="display:none;">
                        <div class="col-md-12">
                            <label class="form-label">Select Day for Weekly Repeat</label>
                            <div class="row">
                                {% set days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'] %}
                                {% for day in days %}
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" 
                                               id="repeat-day-{{ day.lower() }}" 
                                               name="weekly_repeat_day" 
                                               value="{{ day.lower() }}">
                                        <label class="form-check-label" for="repeat-day-{{ day.lower() }}">
                                            {{ day }}
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-3" id="monthly-repeat-container" style="display:none;">
                        <div class="col-md-12">
                            <label for="monthly-repeat-day" class="form-label">Select Day of Month</label>
                            <select class="form-select" id="monthly-repeat-day" name="monthly_repeat_day">
                                {% for day in range(1, 32) %}
                                <option value="{{ day }}">{{ day }}{% if day == 1 %}st{% elif day == 2 %}nd{% elif day == 3 %}rd{% else %}th{% endif %}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3" id="custom-repeat-container" style="display:none;">
                        <div class="col-md-12">
                            <label class="form-label">Select Custom Days</label>
                            <div class="row">
                                {% for day in days %}
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" 
                                               id="custom-day-{{ day.lower() }}" 
                                               name="custom_repeat_days" 
                                               value="{{ day.lower() }}">
                                        <label class="form-check-label" for="custom-day-{{ day.lower() }}">
                                            {{ day }}
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label for="repeat-until" class="form-label">Repeat Until (Optional)</label>
                            <input type="date" class="form-control" id="repeat-until" name="repeat_until">
                            <small class="form-text text-muted">Leave blank for no end date</small>
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary">Add Task</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const taskForm = document.getElementById('task-form');
    const repeatTypeSelect = document.getElementById('repeat-type');
    const repeatDetailsContainer = document.getElementById('repeat-details-container');
    const weeklyRepeatContainer = document.getElementById('weekly-repeat-container');
    const monthlyRepeatContainer = document.getElementById('monthly-repeat-container');
    const customRepeatContainer = document.getElementById('custom-repeat-container');

    // Show/hide repeat details based on repeat type
    repeatTypeSelect.addEventListener('change', () => {
        const selectedType = repeatTypeSelect.value;
        
        // Hide all repeat detail containers
        repeatDetailsContainer.style.display = selectedType === '' ? 'none' : 'block';
        weeklyRepeatContainer.style.display = 'none';
        monthlyRepeatContainer.style.display = 'none';
        customRepeatContainer.style.display = 'none';

        // Show appropriate container based on selected type
        switch(selectedType) {
            case 'weekly':
                weeklyRepeatContainer.style.display = 'block';
                break;
            case 'monthly':
                monthlyRepeatContainer.style.display = 'block';
                break;
            case 'custom':
                customRepeatContainer.style.display = 'block';
                break;
        }
    });

    taskForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData(taskForm);
        const taskData = {
            name: formData.get('name'),
            description: formData.get('description') || null,
            reminder_time: formData.get('reminder_time') || null,
            repeat_type: formData.get('repeat_type') || null,
            weekly_repeat_day: formData.get('weekly_repeat_day') || null,
            monthly_repeat_day: formData.get('monthly_repeat_day') || null,
            custom_repeat_days: formData.getAll('custom_repeat_days'),
            repeat_until: formData.get('repeat_until') || null
        };

        try {
            const response = await fetch('/api/tasks', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(taskData)
            });

            const result = await response.json();

            if (response.ok) {
                showAlert('Task added successfully', 'success');
                taskForm.reset();
                repeatDetailsContainer.style.display = 'none';
            } else {
                showAlert(result.error || 'Error adding task', 'danger');
            }
        } catch (error) {
            showAlert('Error submitting task', 'danger');
            console.error('Error:', error);
        }
    });
});
</script>
{% endblock %}
