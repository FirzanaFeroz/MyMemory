{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-md-12">
            <h2>Add a Person</h2>
            <form id="person-form" enctype="multipart/form-data">
                <div class="form-group mb-3">
                    <label for="name" class="form-label">Name</label>
                    <input type="text" class="form-control" id="name" name="name" required>
                </div>
                <div class="form-group mb-3">
                    <label for="relation" class="form-label">Relation</label>
                    <input type="text" class="form-control" id="relation" name="relation" placeholder="Optional">
                </div>
                <div class="form-group mb-3">
                    <label for="description" class="form-label">Description</label>
                    <textarea class="form-control" id="description" name="description" placeholder="Optional"></textarea>
                </div>
                <div class="form-group mb-3">
                    <label for="photo" class="form-label">Photo</label>
                    <input type="file" class="form-control" id="photo" name="photo" accept="image/*" required>
                    <div class="form-text">Upload a clear, front-facing photo of the person</div>
                </div>
                
                <button type="submit" class="btn btn-primary">Add Person</button>
            </form>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-12">
            <h2>Identify a Person</h2>
            <form id="identify-person-form" enctype="multipart/form-data">
                <div class="form-group mb-3">
                    <label for="identify-photo" class="form-label">Upload Photo to Identify</label>
                    <input type="file" class="form-control" id="identify-photo" name="identify-photo" accept="image/*" required>
                </div>
                <button type="submit" class="btn btn-secondary">Identify Person</button>
            </form>
            <div id="identification-result" class="mt-3"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Person Addition Form
    const personForm = document.getElementById('person-form');
    personForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData(personForm);
        
        // Validate form data
        const name = formData.get('name').trim();
        const photo = formData.get('photo');
        
        if (!name) {
            showAlert('Name is required', 'danger');
            return;
        }
        
        if (!photo || photo.size === 0) {
            showAlert('Photo is required', 'danger');
            return;
        }
        
        try {
            const response = await fetch('/api/people', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (response.ok) {
                showAlert('Person added successfully', 'success');
                personForm.reset();
            } else {
                showAlert(result.error || 'Error adding person', 'danger');
            }
        } catch (error) {
            showAlert('Error submitting form', 'danger');
            console.error('Error:', error);
        }
    });

    // Person Identification Form
    const identifyPersonForm = document.getElementById('identify-person-form');
    const identificationResult = document.getElementById('identification-result');
    
    identifyPersonForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData(identifyPersonForm);
        const photo = formData.get('identify-photo');
        
        if (!photo || photo.size === 0) {
            showAlert('Photo is required for identification', 'danger');
            return;
        }
        
        try {
            const response = await fetch('/api/identify-person', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (response.ok) {
                identificationResult.innerHTML = `
                    <div class="alert alert-success">
                        <strong>Identified Person:</strong> ${result.name}
                        ${result.confidence ? `<br><small>Confidence: ${(result.confidence * 100).toFixed(2)}%</small>` : ''}
                    </div>
                `;
            } else {
                identificationResult.innerHTML = `
                    <div class="alert alert-warning">
                        ${result.error || 'Unable to identify the person'}
                    </div>
                `;
            }
        } catch (error) {
            showAlert('Error identifying person', 'danger');
            console.error('Error:', error);
        }
    });
});
</script>
{% endblock %}
